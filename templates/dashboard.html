{% extends "base.html" %}
{% block title %}Dashboard • Lead Machine Pro{% endblock %}
{% block content %}

<div class="card">
  <h2>Your dashboard</h2>
  <p class="muted">
    Logged in as <strong>{{ user.email }}</strong>
    • Plan: <strong>{{ user.plan }}</strong>
    • Credits: <strong>{{ user.credits }}</strong>
  </p>

  {% if user.is_verified == 0 %}
    <div class="flash error" style="margin-top:12px;">
      Email not verified — leads will still run, but email notifications are disabled until you verify.
    </div>
  {% endif %}

  {% if user.credits <= 0 and user.plan == 'free' %}
    <div class="flash error" style="margin-top:12px;">
      You have 0 credits. Start scanning by topping up or subscribing.
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      {% if UPGRADE_URL %}
        <a class="btn primary" href="{{ UPGRADE_URL }}" target="_blank" rel="noopener">
          Buy credits
        </a>
      {% endif %}
      <a class="btn"
         href="mailto:support@yourdomain.com?subject=Lead%20Machine%20Pro%20-%20Credits%20Top%20Up&body=Account%20email%3A%20{{ user.email }}">
        Request invoice
      </a>
    </div>
  {% endif %}

  <hr style="border:none;border-top:1px solid rgba(255,255,255,0.12);margin:16px 0;">

  <h3 style="margin:0 0 8px;">Create a Search Program</h3>
  <p class="muted" style="margin:0 0 12px;">
    Keywords supports simple boolean with <strong>|</strong> (OR). Example: <code>python | golang</code>.
  </p>

  <form method="POST" style="display:grid;gap:12px;max-width:640px;">
    <div>
      <label class="muted" style="display:block;font-size:12px;margin-bottom:6px;">Program name</label>
      <input name="name" placeholder="My Job Search" style="width:100%;" />
    </div>

    <div>
      <label class="muted" style="display:block;font-size:12px;margin-bottom:6px;">Keywords *</label>
      <input name="keywords" placeholder="recruiter | talent acquisition | headhunter" required style="width:100%;" />
    </div>

    <div>
      <label class="muted" style="display:block;font-size:12px;margin-bottom:6px;">Location</label>
      <input name="location" placeholder="Global (or London, UK, Europe...)" style="width:100%;" />
    </div>

    <button class="btn primary" type="submit" style="justify-content:center;">Create Program</button>
  </form>
</div>

<div class="card" style="margin-top:14px;">
  <h3 style="margin-top:0;">Your Programs</h3>

  {% if programs|length == 0 %}
    <p class="muted">No programs yet. Create one above, then Start it.</p>
  {% endif %}

  <div style="display:grid;gap:12px;">
    {% for p in programs %}
      <div style="border:1px solid rgba(255,255,255,0.12);border-radius:16px;padding:12px;background:rgba(255,255,255,0.04);">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div>
            <strong>{{ p.name }}</strong>
            <div class="muted" style="font-size:12px;margin-top:2px;">
              Status: <strong>{{ p.status }}</strong> • Leads found: <strong>{{ p.leads_found_count }}</strong>
            </div>
            <div class="muted" style="font-size:12px;margin-top:2px;">
              Keywords: {{ p.keywords }} • Location: {{ p.location }}
            </div>
          </div>

          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            {% if p.status != 'running' %}
              <form method="POST" action="/program/{{ p.id }}/start" style="margin:0;">
                <button class="btn primary" type="submit">▶ Start (uses 1 credit / 7 days)</button>
              </form>
            {% else %}
              <form method="POST" action="/program/{{ p.id }}/run_now" style="margin:0;">
                <button class="btn primary" type="submit">⚡ Run now</button>
              </form>

              <form method="POST" action="/program/{{ p.id }}/pause" style="margin:0;">
                <button class="btn" type="submit">⏸ Pause</button>
              </form>
            {% endif %}
          </div>
        </div>

        {% if p.active_until %}
          <div class="muted" style="font-size:12px;margin-top:8px;">
            Active until (UTC): {{ p.active_until }}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <form method="POST" action="/logout" style="margin-top:14px;">
    <button class="btn" type="submit">Logout</button>
  </form>
</div>

{% endblock %}
